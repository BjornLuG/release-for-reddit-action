(()=>{var t={718:function(t,e,r){"use strict";var s=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)if(Object.hasOwnProperty.call(t,r))e[r]=t[r];e["default"]=t;return e};Object.defineProperty(e,"__esModule",{value:true});const n=s(r(87));const i=r(646);function issueCommand(t,e,r){const s=new Command(t,e,r);process.stdout.write(s.toString()+n.EOL)}e.issueCommand=issueCommand;function issue(t,e=""){issueCommand(t,{},e)}e.issue=issue;const o="::";class Command{constructor(t,e,r){if(!t){t="missing.command"}this.command=t;this.properties=e;this.message=r}toString(){let t=o+this.command;if(this.properties&&Object.keys(this.properties).length>0){t+=" ";let e=true;for(const r in this.properties){if(this.properties.hasOwnProperty(r)){const s=this.properties[r];if(s){if(e){e=false}else{t+=","}t+=`${r}=${escapeProperty(s)}`}}}}t+=`${o}${escapeData(this.message)}`;return t}}function escapeData(t){return i.toCommandValue(t).replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A")}function escapeProperty(t){return i.toCommandValue(t).replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A").replace(/:/g,"%3A").replace(/,/g,"%2C")}},404:function(t,e,r){"use strict";var s=this&&this.__awaiter||function(t,e,r,s){function adopt(t){return t instanceof r?t:new r((function(e){e(t)}))}return new(r||(r=Promise))((function(r,n){function fulfilled(t){try{step(s.next(t))}catch(t){n(t)}}function rejected(t){try{step(s["throw"](t))}catch(t){n(t)}}function step(t){t.done?r(t.value):adopt(t.value).then(fulfilled,rejected)}step((s=s.apply(t,e||[])).next())}))};var n=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)if(Object.hasOwnProperty.call(t,r))e[r]=t[r];e["default"]=t;return e};Object.defineProperty(e,"__esModule",{value:true});const i=r(718);const o=r(315);const a=r(646);const u=n(r(87));const c=n(r(622));var p;(function(t){t[t["Success"]=0]="Success";t[t["Failure"]=1]="Failure"})(p=e.ExitCode||(e.ExitCode={}));function exportVariable(t,e){const r=a.toCommandValue(e);process.env[t]=r;const s=process.env["GITHUB_ENV"]||"";if(s){const e="_GitHubActionsFileCommandDelimeter_";const s=`${t}<<${e}${u.EOL}${r}${u.EOL}${e}`;o.issueCommand("ENV",s)}else{i.issueCommand("set-env",{name:t},r)}}e.exportVariable=exportVariable;function setSecret(t){i.issueCommand("add-mask",{},t)}e.setSecret=setSecret;function addPath(t){const e=process.env["GITHUB_PATH"]||"";if(e){o.issueCommand("PATH",t)}else{i.issueCommand("add-path",{},t)}process.env["PATH"]=`${t}${c.delimiter}${process.env["PATH"]}`}e.addPath=addPath;function getInput(t,e){const r=process.env[`INPUT_${t.replace(/ /g,"_").toUpperCase()}`]||"";if(e&&e.required&&!r){throw new Error(`Input required and not supplied: ${t}`)}return r.trim()}e.getInput=getInput;function setOutput(t,e){process.stdout.write(u.EOL);i.issueCommand("set-output",{name:t},e)}e.setOutput=setOutput;function setCommandEcho(t){i.issue("echo",t?"on":"off")}e.setCommandEcho=setCommandEcho;function setFailed(t){process.exitCode=p.Failure;error(t)}e.setFailed=setFailed;function isDebug(){return process.env["RUNNER_DEBUG"]==="1"}e.isDebug=isDebug;function debug(t){i.issueCommand("debug",{},t)}e.debug=debug;function error(t){i.issue("error",t instanceof Error?t.toString():t)}e.error=error;function warning(t){i.issue("warning",t instanceof Error?t.toString():t)}e.warning=warning;function info(t){process.stdout.write(t+u.EOL)}e.info=info;function startGroup(t){i.issue("group",t)}e.startGroup=startGroup;function endGroup(){i.issue("endgroup")}e.endGroup=endGroup;function group(t,e){return s(this,void 0,void 0,(function*(){startGroup(t);let r;try{r=yield e()}finally{endGroup()}return r}))}e.group=group;function saveState(t,e){i.issueCommand("save-state",{name:t},e)}e.saveState=saveState;function getState(t){return process.env[`STATE_${t}`]||""}e.getState=getState},315:function(t,e,r){"use strict";var s=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)if(Object.hasOwnProperty.call(t,r))e[r]=t[r];e["default"]=t;return e};Object.defineProperty(e,"__esModule",{value:true});const n=s(r(747));const i=s(r(87));const o=r(646);function issueCommand(t,e){const r=process.env[`GITHUB_${t}`];if(!r){throw new Error(`Unable to find environment variable for file command ${t}`)}if(!n.existsSync(r)){throw new Error(`Missing file at path: ${r}`)}n.appendFileSync(r,`${o.toCommandValue(e)}${i.EOL}`,{encoding:"utf8"})}e.issueCommand=issueCommand},646:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:true});function toCommandValue(t){if(t===null||t===undefined){return""}else if(typeof t==="string"||t instanceof String){return t}return JSON.stringify(t)}e.toCommandValue=toCommandValue},747:t=>{"use strict";t.exports=require("fs")},211:t=>{"use strict";t.exports=require("https")},87:t=>{"use strict";t.exports=require("os")},622:t=>{"use strict";t.exports=require("path")}};var e={};function __nccwpck_require__(r){var s=e[r];if(s!==undefined){return s.exports}var n=e[r]={exports:{}};var i=true;try{t[r].call(n.exports,n,n.exports,__nccwpck_require__);i=false}finally{if(i)delete e[r]}return n.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var r={};(()=>{const t=__nccwpck_require__(211);const e=__nccwpck_require__(404);class Main{constructor(){this.username=e.getInput("username",{required:true});this.password=e.getInput("password",{required:true});this.appId=e.getInput("app-id",{required:true});this.appSecret=e.getInput("app-secret",{required:true});this.subreddit=e.getInput("subreddit",{required:true});this.title=e.getInput("title",{required:true});this.url=e.getInput("url",{required:true});this.flairId=e.getInput("flair-id");this.flairText=e.getInput("flair-text");this.comment=e.getInput("comment");this.notification=e.getInput("notification")==="true";this.retryRateLimit=+e.getInput("retry-rate-limit");this.userAgent=`Release for Reddit (by /u/${this.username})`;this.accessToken=""}async start(){await this.initAccessToken();const t=await this.submitPost();e.info(`View post at ${t.url}`);e.setOutput("postUrl",t.url);if(this.comment){const r=await this.commentPost(t.name);const s=`https://www.reddit.com${r.permalink}`;e.info(`View comment at ${s}`);e.setOutput("commentUrl",s);if(!this.notification){this.editSendReplies(r.name,false)}}}async initAccessToken(){const t=await this._post({host:"www.reddit.com",path:"/api/v1/access_token",auth:`${this.appId}:${this.appSecret}`},{grant_type:"password",username:this.username,password:this.password});this.accessToken=t["access_token"]}async submitPost(){let t={api_type:"json",resubmit:true,sr:this.subreddit,title:this.title,flair_id:this.flairId,flair_text:this.flairText,sendreplies:this.notification};const e=/^https?:\/\/.*reddit.com\/(?:(.*?)\/){4}/;const r=this.url.match(e);if(r){t.kind="crosspost";t.crosspost_fullname=`t3_${r[1]}`}else{t.kind="link";t.url=this.url}const s=await this._retryIfRateLimit((async()=>{const e=await this._post({host:"oauth.reddit.com",path:`/api/submit`,headers:{Authorization:`Bearer ${this.accessToken}`}},t);if(e.json.errors.length){throw new Error(e.json.errors)}return e}));return s.json.data}async commentPost(t){const e=await this._retryIfRateLimit((async()=>{const e=await this._post({host:"oauth.reddit.com",path:`/api/comment`,headers:{Authorization:`Bearer ${this.accessToken}`}},{api_type:"json",text:this.comment,thing_id:t});if(e.json.errors.length){throw new Error(e.json.errors)}return e}));const r=e.json.data;if(r&&r.things&&r.things[0]){return r.things[0].data}return r}async editSendReplies(t,e){await this._retryIfRateLimit((async()=>{const r=await this._post({host:"oauth.reddit.com",path:`/api/sendreplies`,headers:{Authorization:`Bearer ${this.accessToken}`}},{id:t,state:e});if(r&&r.json&&r.json.errors&&r.json.errors.length){throw new Error(r.json.errors)}return r}))}_post(e,r){const s=this._encodeForm(r);const n={...e,method:"POST",headers:{...e.headers,"User-Agent":this.userAgent,"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(s)}};return new Promise(((e,r)=>{const i=t.request(n,(t=>{t.setEncoding("utf8");let s="";t.on("data",(t=>{s+=t}));t.on("error",(t=>r(t)));t.on("end",(()=>e(JSON.parse(s))))}));i.on("error",(t=>r(t)));i.write(s);i.end()}))}async _retryIfRateLimit(t,r=this.retryRateLimit){try{return await t()}catch(s){const n=this._getRateLimitSeconds(s.message);if(n>0&&r>0){e.info(`Rate limit hit. Waiting ${n} seconds to retry...`);await this._wait(n*1e3);return await this._retryIfRateLimit(t,r-1)}throw s}}_getRateLimitSeconds(t){const e=t.match(/RATELIMIT.*try again in (\d*) (s|m)/);if(!e||e.length<3){return-1}let r=e[1];if(e[2]==="m"){r*=60}r+=60;return r}async _wait(t){return new Promise((e=>{setTimeout((()=>e()),t)}))}_encodeForm(t){return Object.entries(t).map((t=>t.map(encodeURIComponent).join("="))).join("&")}}(new Main).start().catch((t=>e.setFailed(t.message)))})();module.exports=r})();